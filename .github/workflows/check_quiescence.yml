name: Quiescence Monitor Integrity

on:
  push:
    paths:
      - 'quiescence_monitor/**'
      - '.github/workflows/check_quiescence.yml'
  pull_request:
    paths:
      - 'quiescence_monitor/**'
  # Allow manual trigger for Red Team drills
  workflow_dispatch:

jobs:
  smoke-test:
    name: ü¶Ü Monitor Behavior Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install pyyaml flake8

      - name: üîç Static Analysis (Linting)
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 quiescence_monitor/monitor.py --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: üõ†Ô∏è Prepare Runtime Environment (Mocking Root)
        run: |
          # The script expects /var/log and /etc paths. 
          # In CI, we create them and authorize the runner user.
          
          # 1. Logs
          sudo mkdir -p /var/log/quiescence
          sudo chown -R $USER:$USER /var/log/quiescence
          
          # 2. Config
          sudo mkdir -p /etc/quiescence
          sudo chown -R $USER:$USER /etc/quiescence
          
          # 3. Inject Test Config (Verify config loading logic)
          echo "thresholds:
            q1: {drift_max: 0.01, duration_min: '10s'}
            q2: {complementarity_min: 0.90}
            q3: {confidence_min: 0.95}
            q4: {convergence_min: 0.95}" > /etc/quiescence/thresholds.yaml

      - name: ‚ö° Accelerate Time (Hot-Patch)
        run: |
          # The script sleeps for 60s. We patch this to 0.1s for the test cycle
          # to ensure we hit Q1 (cycle 3) instantly without waiting 3 minutes.
          sed -i 's/time.sleep(60)/time.sleep(0.1)/g' quiescence_monitor/monitor.py
          
          echo "‚úÖ Patched sleep timer for High-Velocity testing."

      - name: üöÄ Execute Monitor (Time-Bounded)
        run: |
          # Run the monitor in background, wait 2 seconds (enough for ~20 cycles), then kill it
          timeout 2s python3 quiescence_monitor/monitor.py || true
          
          echo "‚úÖ Monitor execution cycle complete."

      - name: üïµÔ∏è Forensic Audit (Log Verification)
        run: |
          LOG_FILE="/var/log/quiescence/quiescence.log"
          
          if [ ! -f "$LOG_FILE" ]; then
            echo "‚ùå CRITICAL: Log file was not created."
            exit 1
          fi
          
          echo "üìÑ Tail of Log:"
          tail -n 10 "$LOG_FILE"
          
          # ASSERTION 1: Check for startup
          if grep -q "MONITOR_STARTED" "$LOG_FILE"; then
            echo "‚úÖ Startup Event detected."
          else
            echo "‚ùå Startup Event missing."
            exit 1
          fi

          # ASSERTION 2: Check for Q1 (Quack)
          # Needs cycle 3. With 0.1s sleep, 2s timeout should easily hit cycle 3.
          if grep -q "\"marker\": \"Q‚ÇÅ\"" "$LOG_FILE" && grep -q "ü¶Ü" "$LOG_FILE"; then
             echo "‚úÖ Q1 Quiescence Signal (ü¶Ü) detected."
          else
             echo "‚ùå Q1 Signal missing. Loop logic or sleep patch failed."
             exit 1
          fi
