name: Quiescence Monitor Integrity

on:
  push:
    paths:
      - 'quiescence_monitor/**'
      - '.github/workflows/check_quiescence.yml'
  pull_request:
    paths:
      - 'quiescence_monitor/**'
  workflow_dispatch:

jobs:
  smoke-test:
    name: ü¶Ü Monitor Behavior Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # REMOVED: cache: 'pip' (Fixes error when no requirements.txt exists)

      - name: Install Dependencies
        run: |
          pip install pyyaml flake8

      - name: üîç Static Analysis (Linting)
        run: |
          # Stop build if syntax errors exist
          flake8 quiescence_monitor/monitor.py --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: üõ†Ô∏è Prepare Runtime Environment (Mocking Root)
        run: |
          # Create system paths
          sudo mkdir -p /var/log/quiescence
          sudo chown -R $USER:$USER /var/log/quiescence
          
          sudo mkdir -p /etc/quiescence
          sudo chown -R $USER:$USER /etc/quiescence
          
          # Inject Test Config
          echo "thresholds:
            q1: {drift_max: 0.01, duration_min: '10s'}
            q2: {complementarity_min: 0.90}
            q3: {confidence_min: 0.95}
            q4: {convergence_min: 0.95}" > /etc/quiescence/thresholds.yaml

      - name: ‚ö° Accelerate Time (Hot-Patch)
        run: |
          # Patch sleep(60) -> sleep(0.1) for instant feedback
          sed -i 's/time.sleep(60)/time.sleep(0.1)/g' quiescence_monitor/monitor.py
          echo "‚úÖ Patched sleep timer for High-Velocity testing."

      - name: üöÄ Execute Monitor (Time-Bounded)
        run: |
          # Run for 2 seconds then kill
          timeout 2s python3 quiescence_monitor/monitor.py || true
          echo "‚úÖ Monitor execution cycle complete."

      - name: üïµÔ∏è Forensic Audit (Log Verification)
        run: |
          LOG_FILE="/var/log/quiescence/quiescence.log"
          
          if [ ! -f "$LOG_FILE" ]; then
            echo "‚ùå CRITICAL: Log file was not created."
            exit 1
          fi
          
          echo "üìÑ Tail of Log:"
          tail -n 10 "$LOG_FILE"
          
          # Check for Q1 (Quack)
          if grep -q "\"marker\": \"Q‚ÇÅ\"" "$LOG_FILE" && grep -q "ü¶Ü" "$LOG_FILE"; then
             echo "‚úÖ Q1 Quiescence Signal (ü¶Ü) detected."
          else
             echo "‚ùå Q1 Signal missing."
             exit 1
          fi
